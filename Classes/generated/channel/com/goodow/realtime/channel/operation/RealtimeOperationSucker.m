//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: src/main/java/com/goodow/realtime/channel/operation/RealtimeOperationSucker.java
//
//  Created by retechretech on 13-5-25.
//

#import "IOSClass.h"
#import "com/goodow/realtime/Document.h"
#import "com/goodow/realtime/DocumentBridge.h"
#import "com/goodow/realtime/DocumentLoadedHandler.h"
#import "com/goodow/realtime/DocumentSaveStateChangedEvent.h"
#import "com/goodow/realtime/Error.h"
#import "com/goodow/realtime/Model.h"
#import "com/goodow/realtime/ModelInitializerHandler.h"
#import "com/goodow/realtime/Realtime.h"
#import "com/goodow/realtime/channel/PollChannel.h"
#import "com/goodow/realtime/channel/RealtimeChannelDemuxer.h"
#import "com/goodow/realtime/channel/operation/GenericOperationChannel.h"
#import "com/goodow/realtime/channel/operation/RealtimeOperationSucker.h"
#import "com/goodow/realtime/channel/operation/ReceiveOpChannelImpl.h"
#import "com/goodow/realtime/channel/operation/TransformQueue.h"
#import "com/goodow/realtime/channel/rpc/Rpc.h"
#import "com/goodow/realtime/channel/rpc/SaveService.h"
#import "com/goodow/realtime/channel/rpc/SnapshotService.h"
#import "com/goodow/realtime/operation/OperationSink.h"
#import "com/goodow/realtime/operation/RealtimeOperation.h"
#import "com/goodow/realtime/operation/RealtimeTransformer.h"
#import "elemental/json/JsonValue.h"
#import "java/lang/Throwable.h"
#import "java/util/logging/Level.h"
#import "java/util/logging/Logger.h"
#import "GDRRealtime+OCNI.h"
 #import "GDRError+OCNI.h"

@implementation ComGoodowRealtimeChannelOperationRealtimeOperationSucker

static JavaUtilLoggingLogger * ComGoodowRealtimeChannelOperationRealtimeOperationSucker_logger_;
static ComGoodowRealtimeChannelRealtimeChannelDemuxer * ComGoodowRealtimeChannelOperationRealtimeOperationSucker_demuxer_;

@synthesize id_ = id__;
@synthesize userId = userId_;
@synthesize channel = channel_;
@synthesize rpc = rpc_;
@synthesize transformer = transformer_;
@synthesize outputSink = outputSink_;
@synthesize receiveChannel = receiveChannel_;
@synthesize bridge = bridge_;

+ (JavaUtilLoggingLogger *)logger {
  return ComGoodowRealtimeChannelOperationRealtimeOperationSucker_logger_;
}

+ (ComGoodowRealtimeChannelRealtimeChannelDemuxer *)demuxer {
  return ComGoodowRealtimeChannelOperationRealtimeOperationSucker_demuxer_;
}

- (id)initWithNSString:(NSString *)id_
          withNSString:(NSString *)userId {
  if ((self = [super init])) {
    self.id_ = id_;
    self.userId = userId;
  }
  return self;
}

- (void)load__WithGDRDocumentLoadedHandler:(id<GDRDocumentLoadedHandler>)onLoaded
            withGDRModelInitializerHandler:(id<GDRModelInitializerHandler>)opt_initializer
                 withGDRError_ErrorHandler:(id<GDRError_ErrorHandler>)opt_error {
  GDRDocumentBridge *snapshot = [((ComGoodowRealtimeChannelRealtimeChannelDemuxer *) NIL_CHK(ComGoodowRealtimeChannelOperationRealtimeOperationSucker_demuxer_)) getSnapshotWithNSString:id__];
  if (snapshot != nil) {
    [self loadDoucumentWithGDRDocumentLoadedHandler:onLoaded withGDRDocument:snapshot.document];
    return;
  }
  [self init__];
  ComGoodowRealtimeChannelRpcSnapshotService *snapshotService = [[ComGoodowRealtimeChannelRpcSnapshotService alloc] initWithComGoodowRealtimeChannelRpcRpc:rpc_];
  [((ComGoodowRealtimeChannelRpcSnapshotService *) NIL_CHK(snapshotService)) load__WithNSString:id__ withNSString:[GDRRealtime getToken] withBOOL:YES withComGoodowRealtimeChannelRpcSnapshotService_Callback:[[ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$1 alloc] initWithComGoodowRealtimeChannelOperationRealtimeOperationSucker:self withGDRModelInitializerHandler:opt_initializer withGDRDocumentLoadedHandler:onLoaded]];
}

- (void)onAckWithId:(ComGoodowRealtimeOperationRealtimeOperation *)serverHistoryOp
           withBOOL:(BOOL)clean {
}

- (void)onErrorWithJavaLangThrowable:(JavaLangThrowable *)e {
  [((JavaUtilLoggingLogger *) NIL_CHK(ComGoodowRealtimeChannelOperationRealtimeOperationSucker_logger_)) logWithJavaUtilLoggingLevel:[JavaUtilLoggingLevel WARNING] withNSString:@"Unable to save" withJavaLangThrowable:e];
}

- (void)onRemoteOpWithId:(ComGoodowRealtimeOperationRealtimeOperation *)serverHistoryOp {
  while (((ComGoodowRealtimeOperationRealtimeOperation *) [((ComGoodowRealtimeChannelOperationGenericOperationChannel *) NIL_CHK(channel_)) peek]) != nil) {
    [((GDRDocumentBridge *) NIL_CHK(bridge_)) consumeWithId:((ComGoodowRealtimeOperationRealtimeOperation *) [((ComGoodowRealtimeChannelOperationGenericOperationChannel *) NIL_CHK(channel_)) receive])];
  }
}

- (void)onSaveStateChangedWithBOOL:(BOOL)isSaving
                          withBOOL:(BOOL)isPending {
  GDRDocumentSaveStateChangedEvent *event = [[GDRDocumentSaveStateChangedEvent alloc] initWithGDRDocument:((GDRDocumentBridge *) NIL_CHK(bridge_)).document withBOOL:isSaving withBOOL:isPending];
  [((GDRDocumentBridge *) NIL_CHK(bridge_)) fireDocumentSaveStateChangedEventWithGDRDocumentSaveStateChangedEvent:event];
}

- (void)__ocniHandleError__WithId:(id)opt_error
                     withGDRError:(GDRError *)error   {
    GDRErrorBlock block = (GDRErrorBlock) opt_error;
    return block(error);
  }

- (void)__ocniInitializeModel__WithId:(id)opt_initializer
                         withGDRModel:(GDRModel *)model   {
    GDRModelInitializerBlock block = (GDRModelInitializerBlock) opt_initializer;
    return block(model);
  }

- (void)__ocniLoadDoucument__WithId:(id)onLoaded
                    withGDRDocument:(GDRDocument *)document   {
    GDRDocumentLoadedBlock block = (GDRDocumentLoadedBlock) onLoaded;
    return block(document);
  }

- (void)handlerErrorWithGDRError_ErrorHandler:(id<GDRError_ErrorHandler>)opt_error
                                 withGDRError:(GDRError *)error {
  if ([(id) opt_error conformsToProtocol: @protocol(GDRError_ErrorHandler)]) {
    [((id<GDRError_ErrorHandler>) NIL_CHK(opt_error)) handleErrorWithGDRError:error];
  }
  else {
    [self __ocniHandleError__WithId:opt_error withGDRError:error];
  }
}

- (void)init__ OBJC_METHOD_FAMILY_NONE {
  self.rpc = [((ComGoodowRealtimeChannelRealtimeChannelDemuxer *) NIL_CHK(ComGoodowRealtimeChannelOperationRealtimeOperationSucker_demuxer_)) getRpc];
  transformer_ = [[ComGoodowRealtimeOperationRealtimeTransformer alloc] init];
  receiveChannel_ = [[ComGoodowRealtimeChannelOperationReceiveOpChannelImpl alloc] initWithNSString:id__ withComGoodowRealtimeChannelRpcRpc:rpc_ withComGoodowRealtimeOperationTransformer:transformer_];
  ComGoodowRealtimeChannelOperationTransformQueue *queue = [[ComGoodowRealtimeChannelOperationTransformQueue alloc] initWithComGoodowRealtimeOperationTransformer:transformer_];
  ComGoodowRealtimeChannelRpcSaveService *saveService = [[ComGoodowRealtimeChannelRpcSaveService alloc] initWithComGoodowRealtimeChannelRpcRpc:rpc_ withNSString:id__ withNSString:[GDRRealtime getToken]];
  channel_ = [[ComGoodowRealtimeChannelOperationGenericOperationChannel alloc] initWithComGoodowRealtimeChannelOperationTransformQueue:queue withComGoodowRealtimeChannelOperationGenericOperationChannel_ReceiveOpChannel:receiveChannel_ withComGoodowRealtimeChannelOperationGenericOperationChannel_SendOpService:saveService withComGoodowRealtimeChannelOperationGenericOperationChannel_Listener:self];
  outputSink_ = [[ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$2 alloc] initWithComGoodowRealtimeChannelOperationRealtimeOperationSucker:self];
}

- (void)initializeModelWithGDRModelInitializerHandler:(id<GDRModelInitializerHandler>)opt_initializer
                                         withGDRModel:(GDRModel *)model OBJC_METHOD_FAMILY_NONE {
  if ([(id) opt_initializer conformsToProtocol: @protocol(GDRModelInitializerHandler)]) {
    [((id<GDRModelInitializerHandler>) NIL_CHK(opt_initializer)) onInitializerWithGDRModel:model];
  }
  else {
    [self __ocniInitializeModel__WithId:opt_initializer withGDRModel:model];
  }
}

- (void)loadDoucumentWithGDRDocumentLoadedHandler:(id<GDRDocumentLoadedHandler>)onLoaded
                                  withGDRDocument:(GDRDocument *)document {
  if ([(id) onLoaded conformsToProtocol: @protocol(GDRDocumentLoadedHandler)]) {
    [((id<GDRDocumentLoadedHandler>) NIL_CHK(onLoaded)) onLoadedWithGDRDocument:document];
  }
  else {
    [self __ocniLoadDoucument__WithId:onLoaded withGDRDocument:document];
  }
}

+ (void)initialize {
  if (self == [ComGoodowRealtimeChannelOperationRealtimeOperationSucker class]) {
    ComGoodowRealtimeChannelOperationRealtimeOperationSucker_logger_ = [JavaUtilLoggingLogger getLoggerWithNSString:[[IOSClass classWithClass:[ComGoodowRealtimeChannelOperationRealtimeOperationSucker class]] getName]];
    ComGoodowRealtimeChannelOperationRealtimeOperationSucker_demuxer_ = [ComGoodowRealtimeChannelRealtimeChannelDemuxer get];
  }
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  ComGoodowRealtimeChannelOperationRealtimeOperationSucker *typedCopy = (ComGoodowRealtimeChannelOperationRealtimeOperationSucker *) copy;
  typedCopy.id_ = id__;
  typedCopy.userId = userId_;
  typedCopy.channel = channel_;
  typedCopy.rpc = rpc_;
  typedCopy.transformer = transformer_;
  typedCopy.outputSink = outputSink_;
  typedCopy.receiveChannel = receiveChannel_;
  typedCopy.bridge = bridge_;
}

@end
@implementation ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$1

@synthesize this$0 = this$0_;
@synthesize val$opt_initializer = val$opt_initializer_;
@synthesize val$onLoaded = val$onLoaded_;

- (void)onSuccessWithEMJsonValue:(id<EMJsonValue>)snapshot
                    withNSString:(NSString *)sessionId
                         withInt:(int)revision {
  this$0_.bridge = [((ComGoodowRealtimeOperationRealtimeTransformer *) NIL_CHK(this$0_.transformer)) createSnapshotWithEMJsonValue:snapshot];
  [((ComGoodowRealtimeChannelRealtimeChannelDemuxer *) NIL_CHK([ComGoodowRealtimeChannelOperationRealtimeOperationSucker demuxer])) register__WithNSString:this$0_.id_ withGDRDocumentBridge:this$0_.bridge withComGoodowRealtimeChannelOperationReceiveOpChannelImpl:(ComGoodowRealtimeChannelOperationReceiveOpChannelImpl *) this$0_.receiveChannel];
  ((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)).userId = this$0_.userId;
  ((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)).sessionId = sessionId;
  ((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)).outputSink = this$0_.outputSink;
  [((ComGoodowRealtimeChannelOperationGenericOperationChannel *) NIL_CHK(this$0_.channel)) connectWithInt:revision withNSString:sessionId];
  if (revision == 1) {
    [((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)) createRoot];
    if (val$opt_initializer_ != nil) {
      [this$0_ initializeModelWithGDRModelInitializerHandler:val$opt_initializer_ withGDRModel:((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)).model];
    }
  }
  [this$0_ loadDoucumentWithGDRDocumentLoadedHandler:val$onLoaded_ withGDRDocument:((GDRDocumentBridge *) NIL_CHK(this$0_.bridge)).document];
  [[ComGoodowRealtimeChannelPollChannel get] connectWithNSString:sessionId];
}

- (id)initWithComGoodowRealtimeChannelOperationRealtimeOperationSucker:(ComGoodowRealtimeChannelOperationRealtimeOperationSucker *)outer$
                                        withGDRModelInitializerHandler:(id<GDRModelInitializerHandler>)capture$0
                                          withGDRDocumentLoadedHandler:(id<GDRDocumentLoadedHandler>)capture$1 {
  if ((self = [super init])) {
    this$0_ = outer$;
    val$opt_initializer_ = capture$0;
    val$onLoaded_ = capture$1;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$1 *typedCopy = (ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$1 *) copy;
  typedCopy.this$0 = this$0_;
  typedCopy.val$opt_initializer = val$opt_initializer_;
  typedCopy.val$onLoaded = val$onLoaded_;
}

@end
@implementation ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$2

@synthesize this$0 = this$0_;

- (void)consumeWithId:(ComGoodowRealtimeOperationRealtimeOperation *)op {
  [((ComGoodowRealtimeChannelOperationGenericOperationChannel *) NIL_CHK(this$0_.channel)) sendWithId:op];
}

- (NSString *)description {
  return (NSString *) [super description];
}

- (id)initWithComGoodowRealtimeChannelOperationRealtimeOperationSucker:(ComGoodowRealtimeChannelOperationRealtimeOperationSucker *)outer$ {
  if ((self = [super init])) {
    this$0_ = outer$;
  }
  return self;
}

- (void)copyAllPropertiesTo:(id)copy {
  [super copyAllPropertiesTo:copy];
  ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$2 *typedCopy = (ComGoodowRealtimeChannelOperationRealtimeOperationSucker_$2 *) copy;
  typedCopy.this$0 = this$0_;
}

@end
