//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/larry/dev/workspace/realtime/realtime-store/src/main/java/com/goodow/realtime/store/channel/OperationChannel.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "com/goodow/realtime/channel/Bus.h"
#include "com/goodow/realtime/channel/Message.h"
#include "com/goodow/realtime/channel/impl/ReliableSubscribeBus.h"
#include "com/goodow/realtime/core/Handler.h"
#include "com/goodow/realtime/core/Platform.h"
#include "com/goodow/realtime/core/Registration.h"
#include "com/goodow/realtime/core/Scheduler.h"
#include "com/goodow/realtime/json/Json.h"
#include "com/goodow/realtime/json/JsonElement.h"
#include "com/goodow/realtime/json/JsonObject.h"
#include "com/goodow/realtime/operation/Operation.h"
#include "com/goodow/realtime/operation/Transformer.h"
#include "com/goodow/realtime/store/channel/Constants.h"
#include "com/goodow/realtime/store/channel/OperationChannel.h"
#include "com/goodow/realtime/store/channel/TransformQueue.h"
#include "java/lang/AssertionError.h"
#include "java/lang/IllegalArgumentException.h"
#include "java/lang/Throwable.h"
#include "java/lang/Void.h"
#include "java/util/EnumSet.h"
#include "java/util/logging/Level.h"
#include "java/util/logging/Logger.h"

__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_acked(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(ComGoodowRealtimeStoreChannelOperationChannel *self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *newState);
__attribute__((unused)) static jboolean ComGoodowRealtimeStoreChannelOperationChannel_isClean(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static jboolean ComGoodowRealtimeStoreChannelOperationChannel_isConnected(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_maybeEagerlyHandleAckWithDouble_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_maybeSend(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_onAckOwnOperationWithDouble_withComGoodowRealtimeOperationOperation_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt, id<ComGoodowRealtimeOperationOperation> ackedOp);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_onIncomingOperationWithDouble_withComGoodowRealtimeOperationOperation_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt, id<ComGoodowRealtimeOperationOperation> operation);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_sendUnackedOps(ComGoodowRealtimeStoreChannelOperationChannel *self);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(ComGoodowRealtimeStoreChannelOperationChannel *self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *newState);
__attribute__((unused)) static void ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *self, IOSObjectArray *validTransitionStates);

@interface ComGoodowRealtimeStoreChannelOperationChannel () {
 @public
  jboolean isMaybeSendTaskScheduled_;
  id<ComGoodowRealtimeCoreHandler> maybeSendTask_;
  id<ComGoodowRealtimeStoreChannelOperationChannel_Listener> listener_;
  ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *state_;
  ComGoodowRealtimeStoreChannelTransformQueue *queue_;
  NSString *id__;
  id<ComGoodowRealtimeChannelBus> bus_;
  id<ComGoodowRealtimeCoreRegistration> handlerRegistration_;
  id<ComGoodowRealtimeOperationTransformer> transformer_;
}

- (void)acked;

- (void)checkConnected;

- (void)checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)newState;

- (jboolean)isClean;

- (jboolean)isConnected;

- (void)maybeEagerlyHandleAckWithDouble:(jdouble)appliedAt;

- (void)maybeSend;

- (void)onAckOwnOperationWithDouble:(jdouble)appliedAt
withComGoodowRealtimeOperationOperation:(id<ComGoodowRealtimeOperationOperation>)ackedOp;

- (void)onIncomingOperationWithDouble:(jdouble)appliedAt
withComGoodowRealtimeOperationOperation:(id<ComGoodowRealtimeOperationOperation>)operation;

- (void)sendUnackedOps;

- (void)setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)newState;
@end

J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, maybeSendTask_, id<ComGoodowRealtimeCoreHandler>)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, listener_, id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, state_, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, queue_, ComGoodowRealtimeStoreChannelTransformQueue *)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, id__, NSString *)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, bus_, id<ComGoodowRealtimeChannelBus>)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, handlerRegistration_, id<ComGoodowRealtimeCoreRegistration>)
J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel, transformer_, id<ComGoodowRealtimeOperationTransformer>)

@interface ComGoodowRealtimeStoreChannelOperationChannel_StateEnum () {
 @public
  JavaUtilEnumSet *to_;
}

- (void)transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray:(IOSObjectArray *)validTransitionStates;
@end

J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum, to_, JavaUtilEnumSet *)

@interface ComGoodowRealtimeStoreChannelOperationChannel_$1 () {
 @public
  ComGoodowRealtimeStoreChannelOperationChannel *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel_$1, this$0_, ComGoodowRealtimeStoreChannelOperationChannel *)

@interface ComGoodowRealtimeStoreChannelOperationChannel_$2 () {
 @public
  ComGoodowRealtimeStoreChannelOperationChannel *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel_$2, this$0_, ComGoodowRealtimeStoreChannelOperationChannel *)

@interface ComGoodowRealtimeStoreChannelOperationChannel_$3 () {
 @public
  ComGoodowRealtimeStoreChannelOperationChannel *this$0_;
}
@end

J2OBJC_FIELD_SETTER(ComGoodowRealtimeStoreChannelOperationChannel_$3, this$0_, ComGoodowRealtimeStoreChannelOperationChannel *)

BOOL ComGoodowRealtimeStoreChannelOperationChannel_initialized = NO;

@implementation ComGoodowRealtimeStoreChannelOperationChannel

JavaUtilLoggingLogger * ComGoodowRealtimeStoreChannelOperationChannel_logger_;

- (instancetype)initWithNSString:(NSString *)id_
withComGoodowRealtimeOperationTransformer:(id<ComGoodowRealtimeOperationTransformer>)transformer
 withComGoodowRealtimeChannelBus:(id<ComGoodowRealtimeChannelBus>)bus
withComGoodowRealtimeStoreChannelOperationChannel_Listener:(id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>)listener {
  if (self = [super init]) {
    maybeSendTask_ = [[ComGoodowRealtimeStoreChannelOperationChannel_$1 alloc] initWithComGoodowRealtimeStoreChannelOperationChannel:self];
    state_ = ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_UNINITIALISED();
    self->id__ = id_;
    self->transformer_ = transformer;
    self->bus_ = bus;
    self->queue_ = [[ComGoodowRealtimeStoreChannelTransformQueue alloc] initWithComGoodowRealtimeOperationTransformer:transformer];
    self->listener_ = listener;
  }
  return self;
}

- (void)connectWithDouble:(jdouble)version_ {
  NSAssert(!ComGoodowRealtimeStoreChannelOperationChannel_isConnected(self), @"Already connected");
  NSAssert(version_ >= 0, [JreStrcat("$D" J2OBJC_COMMA() @"Invalid version J2OBJC_COMMA() " J2OBJC_COMMA() version_) description]);
  NSString *addr = JreStrcat("$C$$", ComGoodowRealtimeStoreChannelConstants_Topic_get_STORE_(), '/', id__, ComGoodowRealtimeStoreChannelConstants_Topic_get_WATCH_());
  if ([bus_ isKindOfClass:[ComGoodowRealtimeChannelImplReliableSubscribeBus class]]) {
    [((ComGoodowRealtimeChannelImplReliableSubscribeBus *) nil_chk(((ComGoodowRealtimeChannelImplReliableSubscribeBus *) check_class_cast(bus_, [ComGoodowRealtimeChannelImplReliableSubscribeBus class])))) synchronizeSequenceNumberWithNSString:addr withDouble:version_ - 1];
  }
  handlerRegistration_ = [((id<ComGoodowRealtimeChannelBus>) nil_chk(bus_)) subscribeWithNSString:addr withComGoodowRealtimeCoreHandler:[[ComGoodowRealtimeStoreChannelOperationChannel_$2 alloc] initWithComGoodowRealtimeStoreChannelOperationChannel:self]];
  [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(queue_)) init__WithDouble:version_];
  ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_ACKED());
}

- (void)disconnect {
  if (ComGoodowRealtimeStoreChannelOperationChannel_isConnected(self)) {
    [((id<ComGoodowRealtimeCoreRegistration>) nil_chk(handlerRegistration_)) unregister];
    handlerRegistration_ = nil;
    ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_UNINITIALISED());
  }
}

- (id)peek {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
  return [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(queue_)) hasServerOp] ? [queue_ peekServerOp] : nil;
}

- (id)receive {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
  return [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(queue_)) hasServerOp] ? [queue_ removeServerOp] : nil;
}

- (void)sendWithComGoodowRealtimeOperationOperation:(id<ComGoodowRealtimeOperationOperation>)operation {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
  [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(queue_)) clientOpWithComGoodowRealtimeOperationOperation:operation];
  if (!isMaybeSendTaskScheduled_ && [queue_ unackedClientOp] == nil) {
    NSAssert(state_ == ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_ACKED(), @"com/goodow/realtime/store/channel/OperationChannel.java:187 condition failed: assert state == State.ACKED;");
    isMaybeSendTaskScheduled_ = YES;
    [((id<ComGoodowRealtimeCoreScheduler>) nil_chk(ComGoodowRealtimeCorePlatform_scheduler())) scheduleDeferredWithComGoodowRealtimeCoreHandler:maybeSendTask_];
  }
}

- (jdouble)version__ {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
  return [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(queue_)) version__];
}

- (void)acked {
  ComGoodowRealtimeStoreChannelOperationChannel_acked(self);
}

- (void)checkConnected {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
}

- (void)checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)newState {
  ComGoodowRealtimeStoreChannelOperationChannel_checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, newState);
}

- (jboolean)isClean {
  return ComGoodowRealtimeStoreChannelOperationChannel_isClean(self);
}

- (jboolean)isConnected {
  return ComGoodowRealtimeStoreChannelOperationChannel_isConnected(self);
}

- (void)maybeEagerlyHandleAckWithDouble:(jdouble)appliedAt {
  ComGoodowRealtimeStoreChannelOperationChannel_maybeEagerlyHandleAckWithDouble_(self, appliedAt);
}

- (void)maybeSend {
  ComGoodowRealtimeStoreChannelOperationChannel_maybeSend(self);
}

- (void)onAckOwnOperationWithDouble:(jdouble)appliedAt
withComGoodowRealtimeOperationOperation:(id<ComGoodowRealtimeOperationOperation>)ackedOp {
  ComGoodowRealtimeStoreChannelOperationChannel_onAckOwnOperationWithDouble_withComGoodowRealtimeOperationOperation_(self, appliedAt, ackedOp);
}

- (void)onIncomingOperationWithDouble:(jdouble)appliedAt
withComGoodowRealtimeOperationOperation:(id<ComGoodowRealtimeOperationOperation>)operation {
  ComGoodowRealtimeStoreChannelOperationChannel_onIncomingOperationWithDouble_withComGoodowRealtimeOperationOperation_(self, appliedAt, operation);
}

- (void)sendUnackedOps {
  ComGoodowRealtimeStoreChannelOperationChannel_sendUnackedOps(self);
}

- (void)setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)newState {
  ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, newState);
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeStoreChannelOperationChannel *)other {
  [super copyAllFieldsTo:other];
  other->isMaybeSendTaskScheduled_ = isMaybeSendTaskScheduled_;
  other->maybeSendTask_ = maybeSendTask_;
  other->listener_ = listener_;
  other->state_ = state_;
  other->queue_ = queue_;
  other->id__ = id__;
  other->bus_ = bus_;
  other->handlerRegistration_ = handlerRegistration_;
  other->transformer_ = transformer_;
}

+ (void)initialize {
  if (self == [ComGoodowRealtimeStoreChannelOperationChannel class]) {
    ComGoodowRealtimeStoreChannelOperationChannel_logger_ = JavaUtilLoggingLogger_getLoggerWithNSString_([ComGoodowRealtimeStoreChannelOperationChannel_class_() getName]);
    J2OBJC_SET_INITIALIZED(ComGoodowRealtimeStoreChannelOperationChannel)
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithNSString:withComGoodowRealtimeOperationTransformer:withComGoodowRealtimeChannelBus:withComGoodowRealtimeStoreChannelOperationChannel_Listener:", "OperationChannel", NULL, 0x1, NULL },
    { "connectWithDouble:", "connect", "V", 0x1, NULL },
    { "disconnect", NULL, "V", 0x1, NULL },
    { "peek", NULL, "TO;", 0x1, NULL },
    { "receive", NULL, "TO;", 0x1, NULL },
    { "sendWithComGoodowRealtimeOperationOperation:", "send", "V", 0x1, NULL },
    { "version__", "version", "D", 0x1, NULL },
    { "acked", NULL, "V", 0x2, NULL },
    { "checkConnected", NULL, "V", 0x2, NULL },
    { "checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:", "checkState", "V", 0x2, NULL },
    { "isClean", NULL, "Z", 0x2, NULL },
    { "isConnected", NULL, "Z", 0x2, NULL },
    { "maybeEagerlyHandleAckWithDouble:", "maybeEagerlyHandleAck", "V", 0x2, NULL },
    { "maybeSend", NULL, "V", 0x2, NULL },
    { "onAckOwnOperationWithDouble:withComGoodowRealtimeOperationOperation:", "onAckOwnOperation", "V", 0x2, NULL },
    { "onIncomingOperationWithDouble:withComGoodowRealtimeOperationOperation:", "onIncomingOperation", "V", 0x2, NULL },
    { "sendUnackedOps", NULL, "V", 0x2, NULL },
    { "setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum:", "setState", "V", 0x2, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "isMaybeSendTaskScheduled_", NULL, 0x2, "Z", NULL,  },
    { "maybeSendTask_", NULL, 0x12, "Lcom.goodow.realtime.core.Handler;", NULL,  },
    { "logger_", NULL, 0x1a, "Ljava.util.logging.Logger;", &ComGoodowRealtimeStoreChannelOperationChannel_logger_,  },
    { "listener_", NULL, 0x12, "Lcom.goodow.realtime.store.channel.OperationChannel$Listener;", NULL,  },
    { "state_", NULL, 0x2, "Lcom.goodow.realtime.store.channel.OperationChannel$State;", NULL,  },
    { "queue_", NULL, 0x12, "Lcom.goodow.realtime.store.channel.TransformQueue;", NULL,  },
    { "id__", "id", 0x12, "Ljava.lang.String;", NULL,  },
    { "bus_", NULL, 0x12, "Lcom.goodow.realtime.channel.Bus;", NULL,  },
    { "handlerRegistration_", NULL, 0x2, "Lcom.goodow.realtime.core.Registration;", NULL,  },
    { "transformer_", NULL, 0x12, "Lcom.goodow.realtime.operation.Transformer;", NULL,  },
  };
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel = { 1, "OperationChannel", "com.goodow.realtime.store.channel", NULL, 0x1, 18, methods, 10, fields, 0, NULL};
  return &_ComGoodowRealtimeStoreChannelOperationChannel;
}

@end

void ComGoodowRealtimeStoreChannelOperationChannel_acked(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_ACKED());
  if (!self->isMaybeSendTaskScheduled_ && [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) hasQueuedClientOps]) {
    self->isMaybeSendTaskScheduled_ = YES;
    [((id<ComGoodowRealtimeCoreScheduler>) nil_chk(ComGoodowRealtimeCorePlatform_scheduler())) scheduleDeferredWithComGoodowRealtimeCoreHandler:self->maybeSendTask_];
  }
}

void ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  NSCAssert(ComGoodowRealtimeStoreChannelOperationChannel_isConnected(self), @"Not connected");
}

void ComGoodowRealtimeStoreChannelOperationChannel_checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(ComGoodowRealtimeStoreChannelOperationChannel *self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *newState) {
  switch ([newState ordinal]) {
    case ComGoodowRealtimeStoreChannelOperationChannel_State_UNINITIALISED:
    break;
    case ComGoodowRealtimeStoreChannelOperationChannel_State_ACKED:
    NSCAssert([((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) version__] >= 0, @"com/goodow/realtime/store/channel/OperationChannel.java:215 condition failed: assert queue.version() >= 0;");
    NSCAssert([self->queue_ unackedClientOp] == nil, @"com/goodow/realtime/store/channel/OperationChannel.java:216 condition failed: assert queue.unackedClientOp() == null;");
    break;
    case ComGoodowRealtimeStoreChannelOperationChannel_State_WAITING_ACK:
    NSCAssert(!self->isMaybeSendTaskScheduled_, @"com/goodow/realtime/store/channel/OperationChannel.java:219 condition failed: assert !isMaybeSendTaskScheduled;");
    break;
    default:
    @throw [[JavaLangAssertionError alloc] initWithId:JreStrcat("$@$", @"State ", self->state_, @" not implemented")];
  }
}

jboolean ComGoodowRealtimeStoreChannelOperationChannel_isClean(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  ComGoodowRealtimeStoreChannelOperationChannel_checkConnected(self);
  jboolean ret = ![((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) hasQueuedClientOps] && [self->queue_ unackedClientOp] == nil;
  NSCAssert(!ret || self->state_ == ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_ACKED(), @"com/goodow/realtime/store/channel/OperationChannel.java:233 condition failed: assert !ret || state == State.ACKED;");
  return ret;
}

jboolean ComGoodowRealtimeStoreChannelOperationChannel_isConnected(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  return self->state_ != ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_UNINITIALISED();
}

void ComGoodowRealtimeStoreChannelOperationChannel_maybeEagerlyHandleAckWithDouble_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt) {
  id<ComGoodowRealtimeOperationOperation> ownOp = [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) ackOpIfVersionMatchesWithDouble:appliedAt];
  if (ownOp == nil) {
    return;
  }
  [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_INFO_() withNSString:JreStrcat("$D", @"Eagerly acked @", appliedAt)];
  ComGoodowRealtimeStoreChannelOperationChannel_acked(self);
  [((id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>) nil_chk(self->listener_)) onAckWithId:ownOp withBoolean:ComGoodowRealtimeStoreChannelOperationChannel_isClean(self)];
}

void ComGoodowRealtimeStoreChannelOperationChannel_maybeSend(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  if ([((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) unackedClientOp] != nil) {
    [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_INFO_() withNSString:JreStrcat("@$", self->state_, @", Has 1 unacked...")];
    return;
  }
  if ([self->queue_ hasQueuedClientOps]) {
    (void) [self->queue_ pushQueuedOpsToUnacked];
    ComGoodowRealtimeStoreChannelOperationChannel_sendUnackedOps(self);
  }
}

void ComGoodowRealtimeStoreChannelOperationChannel_onAckOwnOperationWithDouble_withComGoodowRealtimeOperationOperation_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt, id<ComGoodowRealtimeOperationOperation> ackedOp) {
  jboolean alreadyAckedByXhr = [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) expectedAckWithDouble:appliedAt];
  if (alreadyAckedByXhr) {
    return;
  }
  [self->queue_ ackClientOpWithDouble:appliedAt];
  [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_INFO_() withNSString:JreStrcat("$D", @"Ack @", appliedAt)];
  ComGoodowRealtimeStoreChannelOperationChannel_acked(self);
  [((id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>) nil_chk(self->listener_)) onAckWithId:ackedOp withBoolean:ComGoodowRealtimeStoreChannelOperationChannel_isClean(self)];
}

void ComGoodowRealtimeStoreChannelOperationChannel_onIncomingOperationWithDouble_withComGoodowRealtimeOperationOperation_(ComGoodowRealtimeStoreChannelOperationChannel *self, jdouble appliedAt, id<ComGoodowRealtimeOperationOperation> operation) {
  [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_FINE_() withNSString:JreStrcat("$DC@", @"Incoming applied @", appliedAt, ' ', self->state_)];
  [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) serverOpWithDouble:appliedAt withComGoodowRealtimeOperationOperation:operation];
  [((id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>) nil_chk(self->listener_)) onRemoteOpWithId:operation];
}

void ComGoodowRealtimeStoreChannelOperationChannel_sendUnackedOps(ComGoodowRealtimeStoreChannelOperationChannel *self) {
  id<ComGoodowRealtimeOperationOperation> unackedClientOp = [((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) unackedClientOp];
  NSCAssert(unackedClientOp != nil, @"com/goodow/realtime/store/channel/OperationChannel.java:298 condition failed: assert unackedClientOp != null;");
  [((JavaUtilLoggingLogger *) nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_logger_)) logWithJavaUtilLoggingLevel:JavaUtilLoggingLevel_get_FINE_() withNSString:JreStrcat("$@$D", @"Sending ", unackedClientOp, @" @", [self->queue_ version__])];
  id<ComGoodowRealtimeJsonJsonObject> delta = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(ComGoodowRealtimeJsonJson_createObject())) setWithNSString:@"action" withId:@"post"])) setWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_ID_() withId:self->id__])) setWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_OP_DATA_() withId:[((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(((id<ComGoodowRealtimeJsonJsonObject>) check_protocol_cast([((id<ComGoodowRealtimeOperationOperation>) nil_chk(unackedClientOp)) toJson], @protocol(ComGoodowRealtimeJsonJsonObject))))) setWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_VERSION_() withDouble:[self->queue_ version__]]];
  (void) [((id<ComGoodowRealtimeChannelBus>) nil_chk(self->bus_)) sendWithNSString:ComGoodowRealtimeStoreChannelConstants_Topic_get_STORE_() withId:delta withComGoodowRealtimeCoreHandler:[[ComGoodowRealtimeStoreChannelOperationChannel_$3 alloc] initWithComGoodowRealtimeStoreChannelOperationChannel:self]];
  ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_WAITING_ACK());
}

void ComGoodowRealtimeStoreChannelOperationChannel_setStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(ComGoodowRealtimeStoreChannelOperationChannel *self, ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *newState) {
  ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *oldState = self->state_;
  NSCAssert([((JavaUtilEnumSet *) nil_chk(((ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *) nil_chk(oldState))->to_)) containsWithId:newState], [JreStrcat("$@$@" J2OBJC_COMMA() @"Invalid state transition " J2OBJC_COMMA() oldState J2OBJC_COMMA() @" -> " J2OBJC_COMMA() newState) description]);
  ComGoodowRealtimeStoreChannelOperationChannel_checkStateWithComGoodowRealtimeStoreChannelOperationChannel_StateEnum_(self, newState);
  self->state_ = newState;
  switch ([newState ordinal]) {
    case ComGoodowRealtimeStoreChannelOperationChannel_State_ACKED:
    if (oldState != ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_get_UNINITIALISED()) {
      [((id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>) nil_chk(self->listener_)) onSaveStateChangedWithBoolean:NO withBoolean:[((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) hasQueuedClientOps]];
    }
    break;
    case ComGoodowRealtimeStoreChannelOperationChannel_State_WAITING_ACK:
    [((id<ComGoodowRealtimeStoreChannelOperationChannel_Listener>) nil_chk(self->listener_)) onSaveStateChangedWithBoolean:YES withBoolean:[((ComGoodowRealtimeStoreChannelTransformQueue *) nil_chk(self->queue_)) hasQueuedClientOps]];
    break;
    default:
    break;
  }
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel)

@interface ComGoodowRealtimeStoreChannelOperationChannel_Listener : NSObject
@end

@implementation ComGoodowRealtimeStoreChannelOperationChannel_Listener

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "onAckWithId:withBoolean:", "onAck", "V", 0x401, NULL },
    { "onErrorWithJavaLangThrowable:", "onError", "V", 0x401, NULL },
    { "onRemoteOpWithId:", "onRemoteOp", "V", 0x401, NULL },
    { "onSaveStateChangedWithBoolean:withBoolean:", "onSaveStateChanged", "V", 0x401, NULL },
  };
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel_Listener = { 1, "Listener", "com.goodow.realtime.store.channel", "OperationChannel", 0x201, 4, methods, 0, NULL, 0, NULL};
  return &_ComGoodowRealtimeStoreChannelOperationChannel_Listener;
}

@end

J2OBJC_INTERFACE_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel_Listener)

BOOL ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_initialized = NO;

ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_values_[3];

@implementation ComGoodowRealtimeStoreChannelOperationChannel_StateEnum

- (void)transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray:(IOSObjectArray *)validTransitionStates {
  ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(self, validTransitionStates);
}

- (instancetype)initWithNSString:(NSString *)__name
                         withInt:(jint)__ordinal {
  return [super initWithNSString:__name withInt:__ordinal];
}

IOSObjectArray *ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_values() {
  ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_init();
  return [IOSObjectArray arrayWithObjects:ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_values_ count:3 type:ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_class_()];
}
+ (IOSObjectArray *)values {
  return ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_values();
}

+ (ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *)valueOfWithNSString:(NSString *)name {
  return ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_valueOfWithNSString_(name);
}

ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_valueOfWithNSString_(NSString *name) {
  ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_init();
  for (int i = 0; i < 3; i++) {
    ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *e = ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_values_[i];
    if ([name isEqual:[e name]]) {
      return e;
    }
  }
  @throw [[JavaLangIllegalArgumentException alloc] initWithNSString:name];
  return nil;
}

- (id)copyWithZone:(NSZone *)zone {
  return self;
}

+ (void)initialize {
  if (self == [ComGoodowRealtimeStoreChannelOperationChannel_StateEnum class]) {
    ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_UNINITIALISED = [[ComGoodowRealtimeStoreChannelOperationChannel_StateEnum alloc] initWithNSString:@"UNINITIALISED" withInt:0];
    ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_ACKED = [[ComGoodowRealtimeStoreChannelOperationChannel_StateEnum alloc] initWithNSString:@"ACKED" withInt:1];
    ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_WAITING_ACK = [[ComGoodowRealtimeStoreChannelOperationChannel_StateEnum alloc] initWithNSString:@"WAITING_ACK" withInt:2];
    {
      ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_UNINITIALISED), [IOSObjectArray newArrayWithObjects:(id[]){ ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_ACKED } count:1 type:ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_class_()]);
      ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_ACKED), [IOSObjectArray newArrayWithObjects:(id[]){ ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_WAITING_ACK } count:1 type:ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_class_()]);
      ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(nil_chk(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_WAITING_ACK), [IOSObjectArray newArrayWithObjects:(id[]){ ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_ACKED } count:1 type:ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_class_()]);
    }
    J2OBJC_SET_INITIALIZED(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum)
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray:", "transitionsTo", "V", 0x82, NULL },
    { "initWithNSString:withInt:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "UNINITIALISED", "UNINITIALISED", 0x4019, "Lcom.goodow.realtime.store.channel.OperationChannel$State;", &ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_UNINITIALISED,  },
    { "ACKED", "ACKED", 0x4019, "Lcom.goodow.realtime.store.channel.OperationChannel$State;", &ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_ACKED,  },
    { "WAITING_ACK", "WAITING_ACK", 0x4019, "Lcom.goodow.realtime.store.channel.OperationChannel$State;", &ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_WAITING_ACK,  },
    { "to_", NULL, 0x2, "Ljava.util.EnumSet;", NULL,  },
  };
  static const char *superclass_type_args[] = {"Lcom.goodow.realtime.store.channel.OperationChannel$State;"};
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel_StateEnum = { 1, "State", "com.goodow.realtime.store.channel", "OperationChannel", 0x4018, 2, methods, 4, fields, 1, superclass_type_args};
  return &_ComGoodowRealtimeStoreChannelOperationChannel_StateEnum;
}

@end

void ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_transitionsToWithComGoodowRealtimeStoreChannelOperationChannel_StateEnumArray_(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum *self, IOSObjectArray *validTransitionStates) {
  self->to_ = JavaUtilEnumSet_ofWithJavaLangEnum_withJavaLangEnumArray_(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum_UNINITIALISED, validTransitionStates);
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel_StateEnum)

@implementation ComGoodowRealtimeStoreChannelOperationChannel_$1

- (void)handleWithId:(id)ignore {
  this$0_->isMaybeSendTaskScheduled_ = NO;
  ComGoodowRealtimeStoreChannelOperationChannel_maybeSend(this$0_);
}

- (instancetype)initWithComGoodowRealtimeStoreChannelOperationChannel:(ComGoodowRealtimeStoreChannelOperationChannel *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeStoreChannelOperationChannel_$1 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "handleWithJavaLangVoid:", "handle", "V", 0x1, NULL },
    { "initWithComGoodowRealtimeStoreChannelOperationChannel:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.store.channel.OperationChannel;", NULL,  },
  };
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel_$1 = { 1, "$1", "com.goodow.realtime.store.channel", "OperationChannel", 0x8000, 2, methods, 1, fields, 0, NULL};
  return &_ComGoodowRealtimeStoreChannelOperationChannel_$1;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel_$1)

@implementation ComGoodowRealtimeStoreChannelOperationChannel_$2

- (void)handleWithId:(id<ComGoodowRealtimeChannelMessage>)message {
  if (!ComGoodowRealtimeStoreChannelOperationChannel_isConnected(this$0_)) {
    return;
  }
  id<ComGoodowRealtimeJsonJsonObject> body = [((id<ComGoodowRealtimeChannelMessage>) nil_chk(message)) body];
  id<ComGoodowRealtimeOperationOperation> op = [((id<ComGoodowRealtimeOperationTransformer>) nil_chk(this$0_->transformer_)) createOperationWithComGoodowRealtimeJsonJsonObject:body];
  jdouble appliedAt = [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk(body)) getNumberWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_VERSION_()];
  if ([((NSString *) nil_chk([((id<ComGoodowRealtimeChannelBus>) nil_chk(this$0_->bus_)) getSessionId])) isEqual:[body getStringWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_SESSION_ID_()]]) {
    ComGoodowRealtimeStoreChannelOperationChannel_onAckOwnOperationWithDouble_withComGoodowRealtimeOperationOperation_(this$0_, appliedAt, op);
  }
  else {
    ComGoodowRealtimeStoreChannelOperationChannel_onIncomingOperationWithDouble_withComGoodowRealtimeOperationOperation_(this$0_, appliedAt, op);
  }
}

- (instancetype)initWithComGoodowRealtimeStoreChannelOperationChannel:(ComGoodowRealtimeStoreChannelOperationChannel *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeStoreChannelOperationChannel_$2 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "handleWithComGoodowRealtimeChannelMessage:", "handle", "V", 0x1, NULL },
    { "initWithComGoodowRealtimeStoreChannelOperationChannel:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.store.channel.OperationChannel;", NULL,  },
  };
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel_$2 = { 1, "$2", "com.goodow.realtime.store.channel", "OperationChannel", 0x8000, 2, methods, 1, fields, 0, NULL};
  return &_ComGoodowRealtimeStoreChannelOperationChannel_$2;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel_$2)

@implementation ComGoodowRealtimeStoreChannelOperationChannel_$3

- (void)handleWithId:(id<ComGoodowRealtimeChannelMessage>)message {
  if (!ComGoodowRealtimeStoreChannelOperationChannel_isConnected(this$0_)) {
    return;
  }
  ComGoodowRealtimeStoreChannelOperationChannel_maybeEagerlyHandleAckWithDouble_(this$0_, [((id<ComGoodowRealtimeJsonJsonObject>) nil_chk([((id<ComGoodowRealtimeChannelMessage>) nil_chk(message)) body])) getNumberWithNSString:ComGoodowRealtimeStoreChannelConstants_Key_get_VERSION_()]);
}

- (instancetype)initWithComGoodowRealtimeStoreChannelOperationChannel:(ComGoodowRealtimeStoreChannelOperationChannel *)outer$ {
  this$0_ = outer$;
  return [super init];
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeStoreChannelOperationChannel_$3 *)other {
  [super copyAllFieldsTo:other];
  other->this$0_ = this$0_;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "handleWithComGoodowRealtimeChannelMessage:", "handle", "V", 0x1, NULL },
    { "initWithComGoodowRealtimeStoreChannelOperationChannel:", "init", NULL, 0x0, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "Lcom.goodow.realtime.store.channel.OperationChannel;", NULL,  },
  };
  static const J2ObjcClassInfo _ComGoodowRealtimeStoreChannelOperationChannel_$3 = { 1, "$3", "com.goodow.realtime.store.channel", "OperationChannel", 0x8000, 2, methods, 1, fields, 0, NULL};
  return &_ComGoodowRealtimeStoreChannelOperationChannel_$3;
}

@end

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(ComGoodowRealtimeStoreChannelOperationChannel_$3)
