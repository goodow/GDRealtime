//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/retechretech/dev/workspace/realtime/realtime-operation/src/main/java/com/goodow/realtime/operation/undo/UndoManagerImpl.java
//
//  Created by retechretech.
//

#include "com/goodow/realtime/json/Json.h"
#include "com/goodow/realtime/json/JsonArray.h"
#include "com/goodow/realtime/operation/Operation.h"
#include "com/goodow/realtime/operation/Transformer.h"
#include "com/goodow/realtime/operation/undo/UndoManagerImpl.h"
#include "com/goodow/realtime/operation/undo/UndoStack.h"
#include "com/goodow/realtime/operation/util/Pair.h"

@implementation ComGoodowRealtimeOperationUndoUndoManagerImpl

- (id)initWithComGoodowRealtimeOperationTransformer:(id<ComGoodowRealtimeOperationTransformer>)algorithms {
  if (self = [super init]) {
    checkpointer_ = [[ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer alloc] init];
    self->algorithms_ = algorithms;
    undoStack_ = [[ComGoodowRealtimeOperationUndoUndoStack alloc] initWithComGoodowRealtimeOperationTransformer:algorithms];
    redoStack_ = [[ComGoodowRealtimeOperationUndoUndoStack alloc] initWithComGoodowRealtimeOperationTransformer:algorithms];
  }
  return self;
}

- (BOOL)canRedo {
  return [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(redoStack_))->stack_)) length] != 0;
}

- (BOOL)canUndo {
  return [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_))->stack_)) length] != 0;
}

- (void)checkpoint {
  [((ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer *) nil_chk(checkpointer_)) checkpoint];
}

- (void)nonUndoableOpWithId:(id<ComGoodowRealtimeOperationOperation>)op {
  [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_)) nonUndoableOperationWithId:op];
  [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(redoStack_)) nonUndoableOperationWithId:op];
}

- (id)redo {
  ComGoodowRealtimeOperationUtilPair *redoPlus = [self redoPlus];
  return redoPlus == nil ? nil : redoPlus->first_;
}

- (ComGoodowRealtimeOperationUtilPair *)redoPlus {
  ComGoodowRealtimeOperationUtilPair *ops = [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(redoStack_)) pop];
  if (ops != nil) {
    [((ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer *) nil_chk(checkpointer_)) checkpoint];
    [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_)) pushWithId:ops->first_];
    [checkpointer_ increment];
  }
  return ops;
}

- (id)undo {
  ComGoodowRealtimeOperationUtilPair *undoPlus = [self undoPlus];
  return undoPlus == nil ? nil : undoPlus->first_;
}

- (void)undoableOpWithId:(id<ComGoodowRealtimeOperationOperation>)op {
  [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_)) pushWithId:op];
  [((ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer *) nil_chk(checkpointer_)) increment];
  [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(redoStack_)) clear];
}

- (ComGoodowRealtimeOperationUtilPair *)undoPlus {
  int numToUndo = [((ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer *) nil_chk(checkpointer_)) releaseCheckpoint];
  if (numToUndo == 0) {
    return nil;
  }
  id<ComGoodowRealtimeJsonJsonArray> operations = [ComGoodowRealtimeJsonJson createArray];
  for (int i = 0; i < numToUndo - 1; ++i) {
    (void) [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(operations)) pushWithId:((ComGoodowRealtimeOperationUtilPair *) nil_chk([((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_)) pop]))->first_];
  }
  ComGoodowRealtimeOperationUtilPair *ops = [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(undoStack_)) pop];
  (void) [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(operations)) pushWithId:((ComGoodowRealtimeOperationUtilPair *) nil_chk(ops))->first_];
  id<ComGoodowRealtimeOperationOperation> op = [((id<ComGoodowRealtimeOperationTransformer>) nil_chk(algorithms_)) composeWithComGoodowRealtimeJsonJsonArray:operations];
  [((ComGoodowRealtimeOperationUndoUndoStack *) nil_chk(redoStack_)) pushWithId:op];
  return [[ComGoodowRealtimeOperationUtilPair alloc] initWithId:op withId:ops->second_];
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeOperationUndoUndoManagerImpl *)other {
  [super copyAllFieldsTo:other];
  other->algorithms_ = algorithms_;
  other->checkpointer_ = checkpointer_;
  other->redoStack_ = redoStack_;
  other->undoStack_ = undoStack_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "initWithComGoodowRealtimeOperationTransformer:", "UndoManagerImpl", NULL, 0x1, NULL },
    { "canRedo", NULL, "Z", 0x1, NULL },
    { "canUndo", NULL, "Z", 0x1, NULL },
    { "checkpoint", NULL, "V", 0x1, NULL },
    { "nonUndoableOpWithId:", "nonUndoableOp", "V", 0x1, NULL },
    { "redo", NULL, "TO;", 0x1, NULL },
    { "redoPlus", NULL, "Lcom.goodow.realtime.operation.util.Pair;", 0x1, NULL },
    { "undo", NULL, "TO;", 0x1, NULL },
    { "undoableOpWithId:", "undoableOp", "V", 0x1, NULL },
    { "undoPlus", NULL, "Lcom.goodow.realtime.operation.util.Pair;", 0x1, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "undoStack_", NULL, 0x12, "Lcom.goodow.realtime.operation.undo.UndoStack;", NULL,  },
    { "redoStack_", NULL, 0x12, "Lcom.goodow.realtime.operation.undo.UndoStack;", NULL,  },
    { "checkpointer_", NULL, 0x12, "Lcom.goodow.realtime.operation.undo.UndoManagerImpl$Checkpointer;", NULL,  },
    { "algorithms_", NULL, 0x12, "Lcom.goodow.realtime.operation.Transformer;", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeOperationUndoUndoManagerImpl = { "UndoManagerImpl", "com.goodow.realtime.operation.undo", NULL, 0x11, 10, methods, 4, fields, 0, NULL};
  return &_ComGoodowRealtimeOperationUndoUndoManagerImpl;
}

@end

@implementation ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer

- (void)checkpoint {
  if (lastPartition_ > 0) {
    (void) [((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(partitions_)) pushWithDouble:lastPartition_];
    lastPartition_ = 0;
  }
}

- (void)increment {
  ++lastPartition_;
}

- (int)releaseCheckpoint {
  if (lastPartition_ > 0) {
    int value = lastPartition_;
    lastPartition_ = 0;
    return value;
  }
  if ([((id<ComGoodowRealtimeJsonJsonArray>) nil_chk(partitions_)) length] == 0) {
    return 0;
  }
  int number = J2ObjCFpToInt([partitions_ getNumberWithInt:[partitions_ length] - 1]);
  (void) [partitions_ removeWithInt:[partitions_ length] - 1];
  return number;
}

- (id)init {
  if (self = [super init]) {
    partitions_ = [ComGoodowRealtimeJsonJson createArray];
    lastPartition_ = 0;
  }
  return self;
}

- (void)copyAllFieldsTo:(ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer *)other {
  [super copyAllFieldsTo:other];
  other->lastPartition_ = lastPartition_;
  other->partitions_ = partitions_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "checkpoint", NULL, "V", 0x0, NULL },
    { "increment", NULL, "V", 0x0, NULL },
    { "releaseCheckpoint", NULL, "I", 0x0, NULL },
    { "init", NULL, NULL, 0x2, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "partitions_", NULL, 0x12, "Lcom.goodow.realtime.json.JsonArray;", NULL,  },
    { "lastPartition_", NULL, 0x2, "I", NULL,  },
  };
  static J2ObjcClassInfo _ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer = { "Checkpointer", "com.goodow.realtime.operation.undo", "UndoManagerImpl", 0x1a, 4, methods, 2, fields, 0, NULL};
  return &_ComGoodowRealtimeOperationUndoUndoManagerImpl_Checkpointer;
}

@end
